<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Isolated</title>
  <style>
    /* Все стили как в index.html */
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #0f0f0f;
      background-image: radial-gradient(#222 1px, transparent 1px);
      background-size: 20px 20px;
      overflow: hidden;
    }
    .menu {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255,255,255,0.05);
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9em;
      color: #aaa;
      z-index: 3000;
      user-select: none;
    }
    .workspace {
      width: 100vw;
      min-height: 100vh;
      overflow-y: auto;
      position: relative;
    }
    .canvas {
      position: relative;
      top: 0;
      left: 0;
      transform-origin: top left;
      transition: transform 0.1s ease;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      padding: 100px 40px 200px 40px;
      width: 100%;
      box-sizing: border-box;
      min-height: 100vh;
    }
    .tile {
      border-radius: 12px;
      border: 4px solid transparent;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      background-color: #111;
      position: relative;
      cursor: move; /* draggable */
      overflow: hidden;
      z-index: 1;
      will-change: transform;
    }
    .tile.dragging {
      transform: scale(1.05) translateY(-5px);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }
    .tile img,
    .tile video {
      display: block;
      border-radius: 8px;
      pointer-events: none;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .admin-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 5000;
    }
    .admin-panel button {
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 1px solid #666;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="menu">Admin Panel</div>
  <div class="admin-panel">
    <button id="saveLayout">Save Layout</button>
  </div>
  <div class="workspace">
    <div class="canvas" id="canvas"></div>
  </div>

  <script>
    const works = [
      { type: 'image', src: 'thumbs/image1.png' },
      { type: 'video', src: 'thumbs/balenciaga.mp4' },
      { type: 'video', src: 'thumbs/brds.mp4' },
      { type: 'image', src: 'thumbs/mkc.png' },
      { type: 'video', src: 'thumbs/sora11.mp4' }
    ];

    const canvas = document.getElementById('canvas');

    // Создание плиток с liftTile и абсолютным drag
    function buildTiles() {
      canvas.innerHTML = '';
      works.forEach(work => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.style.width = '300px';
        tile.style.height = '300px';

        let content;
        if (work.type === 'image') {
          content = document.createElement('img');
          content.src = work.src;
        } else {
          content = document.createElement('video');
          content.src = work.src;
          content.autoplay = true;
          content.loop = true;
          content.muted = true;
          content.playsInline = true;
        }
        tile.appendChild(content);
        canvas.appendChild(tile);
      });
    }

    buildTiles();

    // Drag & drop с liftTile
    let activeTile = null;
    let offsetX = 0;
    let offsetY = 0;
    let isDraggingCanvas = false;
    let dragStartX = 0;
    let dragStartY = 0;

    let canvasX = 0;
    let canvasY = 0;
    let canvasScale = 1;

    function updateCanvasTransform() {
      canvas.style.transform = `translate(${canvasX}px, ${canvasY}px) scale(${canvasScale})`;
    }
    updateCanvasTransform();

    function liftTile(tile, pointerClientX, pointerClientY) {
      if (tile.classList.contains('floating')) return;

      const canvasRect = canvas.getBoundingClientRect();
      const tileRect = tile.getBoundingClientRect();

      const localLeft = (tileRect.left - canvasRect.left) / canvasScale;
      const localTop  = (tileRect.top  - canvasRect.top)  / canvasScale;

      const w = tileRect.width / canvasScale;
      const h = tileRect.height / canvasScale;

      tile.style.width = w + 'px';
      tile.style.height = h + 'px';

      tile.classList.add('floating');
      tile.style.left = localLeft + 'px';
      tile.style.top = localTop + 'px';

      offsetX = (pointerClientX - tileRect.left) / canvasScale;
      offsetY = (pointerClientY - tileRect.top) / canvasScale;
    }

    document.addEventListener('mousedown', e => {
      const tile = e.target.closest('.tile');
      if (tile) {
        liftTile(tile, e.clientX, e.clientY);
        activeTile = tile;
        tile.classList.add('dragging');
        tile.style.zIndex = 2002;
        e.preventDefault();
      } else {
        isDraggingCanvas = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
      }
    });

    document.addEventListener('mousemove', e => {
      if (activeTile) {
        const canvasRect = canvas.getBoundingClientRect();
        const newX = (e.clientX - canvasRect.left) / canvasScale - offsetX;
        const newY = (e.clientY - canvasRect.top) / canvasScale - offsetY;
        activeTile.style.left = `${newX}px`;
        activeTile.style.top = `${newY}px`;
      } else if (isDraggingCanvas) {
        const dx = e.clientX - dragStartX;
        const dy = e.clientY - dragStartY;
        canvasX += dx;
        canvasY += dy;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        updateCanvasTransform();
      }
    });

    document.addEventListener('mouseup', () => {
      if (activeTile) {
        activeTile.classList.remove('dragging');
        activeTile.style.zIndex = 2001;
        activeTile = null;
      }
      isDraggingCanvas = false;
    });

    document.addEventListener('wheel', e => {
      if (e.ctrlKey) return;
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      const oldScale = canvasScale;
      const scaleAmount = e.deltaY > 0 ? 0.95 : 1.05;
      canvasScale *= scaleAmount;
      canvasScale = Math.max(0.2, Math.min(canvasScale, 3));

      const scaleChange = canvasScale / oldScale;
      canvasX = mouseX - (mouseX - canvasX) * scaleChange;
      canvasY = mouseY - (mouseY - canvasY) * scaleChange;

      updateCanvasTransform();
    }, { passive: false });

    // Сохранение layout
    document.getElementById('saveLayout').addEventListener('click', () => {
      const tiles = document.querySelectorAll('.tile');
      const layout = [];
      tiles.forEach(tile => {
        const el = tile.querySelector('img, video');
        layout.push({
          src: el.src,
          type: el.tagName.toLowerCase(),
          left: parseFloat(tile.style.left || 0),
          top: parseFloat(tile.style.top || 0),
          width: parseFloat(tile.style.width),
          height: parseFloat(tile.style.height)
        });
      });
      const blob = new Blob([JSON.stringify(layout, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "positions.json";
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
